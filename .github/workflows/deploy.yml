name: Deploy Firebase Functions

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Firebase Project ID'
        required: true
        type: string
      google_account:
        description: 'Google account email (e.g., saqib@dineplatform.com)'
        required: true
        type: string
      env_variables:
        description: 'Environment variables (JSON format)'
        required: true
        type: string
      deployment_id:
        description: 'Unique deployment ID for tracking'
        required: true
        type: string
      webhook_url:
        description: 'Webhook URL for status updates'
        required: false
        type: string
      webhook_secret:
        description: 'Webhook Secret'
        required: false
        type: string
      original_webhook_url:
        description: 'Original webhook URL to forward final results'
        required: false
        type: string
      original_webhook_secret:
        description: 'Original webhook secret'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Generate secret name from Google account
      run: |
        # Convert email to secret name format
        GOOGLE_ACCOUNT="${{ github.event.inputs.google_account }}"
        SECRET_NAME="key_$(echo "$GOOGLE_ACCOUNT" | sed 's/[^a-zA-Z0-9]/_/g')"
        echo "SECRET_NAME=$SECRET_NAME" >> $GITHUB_ENV
        echo "Generated secret name: $SECRET_NAME"
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets[env.SECRET_NAME] }}
        project_id: ${{ github.event.inputs.project_id }}
    
    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
    
    - name: Enable required APIs and setup permissions
      run: |
        echo "üîß Enabling all required APIs..."
        PROJECT_NUMBER=$(gcloud projects describe ${{ github.event.inputs.project_id }} --format="value(projectNumber)")
        echo "Project number: $PROJECT_NUMBER"
        
        # Enable ALL required APIs first (including Compute Engine which was missing)
        echo "üîß Enabling required APIs..."
        gcloud services enable cloudbuild.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Cloud Build API already enabled"
        gcloud services enable cloudfunctions.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Cloud Functions API already enabled"
        gcloud services enable artifactregistry.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Artifact Registry API already enabled"
        gcloud services enable storage.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Storage API already enabled"
        gcloud services enable eventarc.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Eventarc API already enabled"
        gcloud services enable pubsub.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Pub/Sub API already enabled"
        gcloud services enable run.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Cloud Run API already enabled"
        gcloud services enable compute.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Compute Engine API already enabled"
        gcloud services enable logging.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Logging API already enabled"
        gcloud services enable monitoring.googleapis.com --project=${{ github.event.inputs.project_id }} || echo "Monitoring API already enabled"
        
        echo "‚è≥ Waiting 3 seconds for APIs to be fully enabled..."
        sleep 3
        
        # Define the service accounts
        CLOUDBUILD_SA="${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com"
        COMPUTE_SA="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"
        FUNCTIONS_SA="service-${PROJECT_NUMBER}@gcf-admin-robot.iam.gserviceaccount.com"
        
        echo "Cloud Build service account: $CLOUDBUILD_SA"
        echo "Compute Engine service account: $COMPUTE_SA"
        echo "Cloud Functions service account: $FUNCTIONS_SA"
        
        echo "üîß Setting up comprehensive permissions..."
        
        # Grant extensive roles to Cloud Build service account
        echo "üîß Granting roles to Cloud Build service account..."
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${CLOUDBUILD_SA}" \
          --role="roles/cloudfunctions.admin" || echo "Cloud Functions Admin role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${CLOUDBUILD_SA}" \
          --role="roles/iam.serviceAccountUser" || echo "IAM Service Account User role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${CLOUDBUILD_SA}" \
          --role="roles/artifactregistry.writer" || echo "Artifact Registry Writer role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${CLOUDBUILD_SA}" \
          --role="roles/storage.admin" || echo "Storage Admin role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${CLOUDBUILD_SA}" \
          --role="roles/eventarc.admin" || echo "Eventarc Admin role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${CLOUDBUILD_SA}" \
          --role="roles/run.admin" || echo "Cloud Run Admin role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${CLOUDBUILD_SA}" \
          --role="roles/compute.networkUser" || echo "Compute Network User role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${CLOUDBUILD_SA}" \
          --role="roles/logging.logWriter" || echo "Logging Writer role assignment failed"
        
        # Grant comprehensive roles to Compute Engine service account
        echo "üîß Granting roles to Compute Engine service account..."
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${COMPUTE_SA}" \
          --role="roles/storage.objectViewer" || echo "Storage Object Viewer role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${COMPUTE_SA}" \
          --role="roles/storage.admin" || echo "Storage Admin role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${COMPUTE_SA}" \
          --role="roles/cloudfunctions.serviceAgent" || echo "Cloud Functions Service Agent role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${COMPUTE_SA}" \
          --role="roles/run.serviceAgent" || echo "Cloud Run Service Agent role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${COMPUTE_SA}" \
          --role="roles/artifactregistry.reader" || echo "Artifact Registry Reader role assignment failed"
        
        # Grant roles to Cloud Functions service account
        echo "üîß Granting roles to Cloud Functions service account..."
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${FUNCTIONS_SA}" \
          --role="roles/storage.objectViewer" || echo "Functions SA Storage Object Viewer role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${FUNCTIONS_SA}" \
          --role="roles/storage.admin" || echo "Functions SA Storage Admin role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${FUNCTIONS_SA}" \
          --role="roles/artifactregistry.reader" || echo "Functions SA Artifact Registry Reader role assignment failed"
        
        # Additional service accounts that might be needed
        EVENTARC_SA="service-${PROJECT_NUMBER}@gcp-sa-eventarc.iam.gserviceaccount.com"
        PUBSUB_SA="service-${PROJECT_NUMBER}@gcp-sa-pubsub.iam.gserviceaccount.com"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${EVENTARC_SA}" \
          --role="roles/eventarc.serviceAgent" || echo "Eventarc SA role assignment failed"
        
        gcloud projects add-iam-policy-binding ${{ github.event.inputs.project_id }} \
          --member="serviceAccount:${PUBSUB_SA}" \
          --role="roles/pubsub.serviceAgent" || echo "Pub/Sub SA role assignment failed"
        
        echo "‚úÖ All permission assignments completed"
        echo "‚è≥ Waiting 3 seconds for permissions to propagate..."
        sleep 3
    
    - name: Send success webhook notification
      if: success() && github.event.inputs.webhook_url != ''
      run: |
        echo "üì° Sending success webhook notification..."
        
        WEBHOOK_PAYLOAD=$(cat <<EOF
        {
          "webhookSecret": "${{ github.event.inputs.webhook_secret }}",
          "response": {
            "status": "success",
            "message": "Cloud Functions initialization completed successfully.",
            "projectId": "${{ github.event.inputs.project_id }}",
            "deploymentId": "${{ github.event.inputs.deployment_id }}",
            "repository": "dineplatform/cloud-functions-init",
            "googleAccount": "${{ github.event.inputs.google_account }}",
            "completedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          },
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "originalWebhookUrl": "${{ github.event.inputs.original_webhook_url }}",
          "originalWebhookSecret": "${{ github.event.inputs.original_webhook_secret }}"
        }
        EOF
        )
        
        echo "Webhook payload:"
        echo "$WEBHOOK_PAYLOAD"
        
        curl -X POST "${{ github.event.inputs.webhook_url }}" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-CF-Init/1.0" \
          -d "$WEBHOOK_PAYLOAD" \
          --max-time 30 \
          --retry 3 \
          --retry-delay 5 || echo "‚ö†Ô∏è Webhook delivery failed, but deployment was successful"

    - name: Send failure webhook notification
      if: failure() && github.event.inputs.webhook_url != ''
      run: |
        echo "üì° Sending failure webhook notification..."
        
        WEBHOOK_PAYLOAD=$(cat <<EOF
        {
          "webhookSecret": "${{ github.event.inputs.webhook_secret }}",
          "response": {
            "status": "error",
            "error": "Cloud Functions initialization failed",
            "message": "The deployment workflow failed. Check the GitHub Actions logs for details.",
            "projectId": "${{ github.event.inputs.project_id }}",
            "deploymentId": "${{ github.event.inputs.deployment_id }}",
            "repository": "dineplatform/cloud-functions-init",
            "googleAccount": "${{ github.event.inputs.google_account }}",
            "failedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflowUrl": "https://github.com/dineplatform/cloud-functions-init/actions/runs/${{ github.run_id }}"
          },
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "originalWebhookUrl": "${{ github.event.inputs.original_webhook_url }}",
          "originalWebhookSecret": "${{ github.event.inputs.original_webhook_secret }}"
        }
        EOF
        )
        
        echo "Webhook payload:"
        echo "$WEBHOOK_PAYLOAD"
        
        curl -X POST "${{ github.event.inputs.webhook_url }}" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions-CF-Init/1.0" \
          -d "$WEBHOOK_PAYLOAD" \
          --max-time 30 \
          --retry 3 \
          --retry-delay 5 || echo "‚ö†Ô∏è Webhook delivery failed"